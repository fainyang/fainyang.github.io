<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" href="/lib/Han/dist/han.min.css?v=3.3">





















<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.1',
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="This blog is for record what I learn from this Operation Course">
<meta name="keywords" content="shell,nginx">
<meta property="og:type" content="article">
<meta property="og:title" content="Operation Course Record">
<meta property="og:url" content="http://feiyang233.club/post/operation-course/index.html">
<meta property="og:site_name" content="feiyang&#39;s blog">
<meta property="og:description" content="This blog is for record what I learn from this Operation Course">
<meta property="og:locale" content="en">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200216173928.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125517.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125522.png">
<meta property="og:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200301123058.png">
<meta property="og:updated_time" content="2020-03-01T04:46:22.581Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Operation Course Record">
<meta name="twitter:description" content="This blog is for record what I learn from this Operation Course">
<meta name="twitter:image" content="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200216173928.png">






  <link rel="canonical" href="http://feiyang233.club/post/operation-course/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Operation Course Record | feiyang's blog</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">feiyang's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">费洋的博客</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>About</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://feiyang233.club/post/operation-course/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="feiyang">
      <meta itemprop="description" content="佛系咸鱼">
      <meta itemprop="image" content="/images/feiy.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="feiyang's blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Operation Course Record

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-02-13 18:56:35" itemprop="dateCreated datePublished" datetime="2020-02-13T18:56:35+08:00">2020-02-13</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-03-01 12:46:22" itemprop="dateModified" datetime="2020-03-01T12:46:22+08:00">2020-03-01</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Linux/" itemprop="url" rel="index"><span itemprop="name">Linux</span></a></span>

                
                
              
            </span>
          

          
            
            
              
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
            
                <span class="post-meta-item-text">Comments: </span>
                <a href="/post/operation-course/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="post/operation-course/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          
            <span id="/post/operation-course/" class="leancloud_visitors" data-flag-title="Operation Course Record">
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              
                <span class="post-meta-item-text">Views: </span>
              
                <span class="leancloud-visitors-count"></span>
            </span>
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>This blog is for record what I learn from this <a href="https://kaiwu.lagou.com/course/courseInfo.htm?courseId=42#/detail/pc?id=1546" target="_blank" rel="noopener">Operation Course</a></p>
<a id="more"></a>
<h1 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h1><h2 id="SHORTCUTS"><a href="#SHORTCUTS" class="headerlink" title="SHORTCUTS"></a>SHORTCUTS</h2><p>Ctrl + r：find the histroy<br>Ctrl + l：clear the terminal<br>Ctrl + a \ Ctrl + e：move to head\end in row<br>Ctrl + w \ Ctrl + k：delete before\after cursor</p>
<p>ZZ : VIM save and quit</p>
<p>Ctrl+C: Interrupt (kill) the current foreground process running in in the terminal. This sends the SIGINT signal to the process, which is technically just a request—most processes will honor it, but some may ignore it.<br>Ctrl+Z: Suspend the current foreground process running in bash. This sends the SIGTSTP signal to the process. To return the process to the foreground later, use the fg process_name command.<br>Ctrl+D: Close the bash shell. This sends an EOF (End-of-file) marker to bash, and bash exits when it receives this marker. This is similar to running the exit command.</p>
<p>top SHORTCUTS  </p>
<p>Shift + p：Sort by CPU<br>Shift + m：Sort by Memory</p>
<h2 id="find-large-file"><a href="#find-large-file" class="headerlink" title="find large file"></a>find large file</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">du -x --max-depth=1 / |sort -k1 -nr</span><br><span class="line">du -x -d 1 -h / |sort -k1 -nr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> find <span class="built_in">which</span> folder has most inode</span></span><br><span class="line">find -type f | awk -F / -v OFS=/ '&#123;$NF="";dir[$0]++&#125;END&#123;for(i in dir)print dir[i]" "i&#125;'| sort -k1 -nr | head</span><br><span class="line"></span><br><span class="line">769 ./wrk/obj/openssl-1.1.1b/test/</span><br><span class="line">551 ./.cache/mozilla/firefox/hha91z74.default-release/cache2/entries/</span><br><span class="line">462 ./wrk/obj/openssl-1.1.1b/doc/man3/</span><br><span class="line">229 ./wrk/obj/LuaJIT-2.1.0-beta3/src/</span><br><span class="line">212 ./wrk/obj/openssl-1.1.1b/test/certs/</span><br><span class="line">207 ./wrk/obj/openssl-1.1.1b/apps/</span><br><span class="line">199 ./wrk/obj/openssl-1.1.1b/crypto/asn1/</span><br><span class="line">194 ./.cache/gnome-software/icons/</span><br><span class="line">185 ./wrk/obj/openssl-1.1.1b/crypto/evp/</span><br><span class="line">157 ./wrk/obj/openssl-1.1.1b/test/recipes/</span><br></pre></td></tr></table></figure>
<h2 id="rename"><a href="#rename" class="headerlink" title="rename"></a>rename</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> find consumer.xml file and replace all aaaaaa to bbbbbb</span></span><br><span class="line">find ./ -type f -name consumer.xml -exec sed -i "s/aaaaaa/bbbbbb/g" &#123;&#125; \;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> find all .txt file and compress <span class="keyword">then</span> copy to /home/.</span></span><br><span class="line">(find . -name "*.txt"|xargs tar -cvf test.tar) &amp;&amp; cp -f test.tar /home/.</span><br></pre></td></tr></table></figure>
<h2 id="network"><a href="#network" class="headerlink" title="network"></a>network</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> network status</span></span><br><span class="line">netstat -n | awk '/^tcp/ &#123;++S[$NF]&#125; END &#123;for(a in S) print a, S[a]&#125;'</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> get IP </span></span><br><span class="line">ip a|grep "global"|awk '&#123;print $2&#125;'| awk -F/ '&#123;print $1&#125;'</span><br></pre></td></tr></table></figure>
<h1 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h1><ol>
<li><a href="https://mp.weixin.qq.com/s/IRQq3h4mur60rjVfcLsBzA" target="_blank" rel="noopener">Nginx是什么？能干什么？</a></li>
</ol>
<h2 id="cpu-affinity"><a href="#cpu-affinity" class="headerlink" title="cpu affinity"></a>cpu affinity</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_cpu_affinity</span> auto</span><br></pre></td></tr></table></figure>
<p><a href="http://nginx.org/en/docs/ngx_core_module.html#worker_cpu_affinity" target="_blank" rel="noopener">offical document</a></p>
<h2 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h2><p>Add in kernel 2.6</p>
<ol>
<li>epoll’s event flow model is thread-safe;</li>
<li>epoll follow the selection model and improve efficiency;</li>
<li>epoll is event-driven. You can select the relevant state of the entire file to be scanned according to your needs. epoll avoids replacing the scanned file according to the event. You can directly call the callback function, which is more efficient.</li>
<li>Removed the maximum limit on the number of file sizes that can be monitored by the temporary process inside the select model (1024). If you have used an earlier version of Apache, the selection model it uses will be delayed when the request exceeds 1000. The request is wrong, and the performance will be significantly improved by using Nginx.</li>
<li>In addition, an optimization place involved in the events {} configuration is worker_connections, which is also set in events. Through the above learning, we know the role of the worker thread, and the connections supported by each worker thread are Limited, it will be set to 1024 by default here, and when we are dealing with high concurrency scenarios, it is often too low to split worker threads to 1024. It is recommended that you increase the worker_connections, you can refer to the actual business needs Nginx processing Maximum to increase this setting.</li>
</ol>
<h2 id="sendfile"><a href="#sendfile" class="headerlink" title="sendfile"></a>sendfile</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200216173928.png" alt><br>refer <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#sendfile" target="_blank" rel="noopener">docs</a><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /video/ &#123;</span><br><span class="line">    <span class="attribute">sendfile</span>       <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">tcp_nopush</span>     <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">aio</span>            <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="gzip"><a href="#gzip" class="headerlink" title="gzip"></a>gzip</h2><p><a href="http://nginx.org/en/docs/http/ngx_http_gzip_module.html" target="_blank" rel="noopener">docs</a></p>
<ol>
<li><code>gzip on</code> is responsible for turning on the compression function of the backend;</li>
<li><code>gzip_buffer 16 8k</code> means to set the memory space of Nginx when processing file compression;</li>
<li><code>gzip_comp_level 6</code> indicates the compression level of Nginx when processing compression. Generally, the higher the level, the larger the compression ratio. However, it does not mean that the larger the compression ratio, the better. It is still necessary to choose a suitable compression ratio according to the actual situation. The compression ratio is too large. Affects performance. Compression ratio is too small to achieve the desired effect. Generally, it is recommended that you set it to 6 to be more appropriate.</li>
<li><code>gzip_http_version 1.1</code> means only compress the HTTP 1.1 version of the protocol;</li>
<li><code>gzip_min_length 256</code> means that compression is performed only when the length is greater than the minimum 256 bytes, and if it is less than this length, no compression is performed;</li>
<li><code>gzip_proxied any</code> means that Nginx as a reverse proxy sets some gzip compression policies based on the information returned by the backend server;</li>
<li><code>gzip_vary on</code> indicates whether to send Vary: Accept_Encoding response header field, to realize that the receiver server is gzip compressed;</li>
<li><code>application / vnd.ms-fontobject image / x-icon</code>; gip compression type;</li>
<li>g<code>zip_disable &quot;msie6&quot;</code>; Turn off compression for IE6.</li>
</ol>
<h2 id="Timing-Variables"><a href="#Timing-Variables" class="headerlink" title="Timing Variables"></a>Timing Variables</h2><ul>
<li><a href="https://nginx.org/en/docs/http/ngx_http_core_module.html?&amp;_ga=2.258153418.1195201124.1581934594-512055108.1581845805#var_request_time" target="_blank" rel="noopener">request_time</a> – Full request time, starting when NGINX reads the first byte from the client and ending when NGINX sends the last byte of the response body</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html?&amp;_ga=2.258153418.1195201124.1581934594-512055108.1581845805#var_upstream_connect_time" target="_blank" rel="noopener">upstream_connect_time</a> – Time spent establishing a connection with an upstream server</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html?&amp;_ga=2.57291882.1195201124.1581934594-512055108.1581845805#var_upstream_header_time" target="_blank" rel="noopener">upstream_header_time</a> – Time between establishing a connection to an upstream server and receiving the first byte of the response header</li>
<li><a href="https://nginx.org/en/docs/http/ngx_http_upstream_module.html?&amp;_ga=2.258153418.1195201124.1581934594-512055108.1581845805#var_upstream_response_time" target="_blank" rel="noopener">upstream_response_time</a> – Time between establishing a connection to an upstream server and receiving the last byte of the response body</li>
</ul>
<h2 id="nginx-cache"><a href="#nginx-cache" class="headerlink" title="nginx cache"></a>nginx cache</h2><ol>
<li>ssl_session_cache</li>
<li><p>open_file_cache</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">index</span> index.htm index.html;</span><br><span class="line">    <span class="attribute">expires</span> max;  </span><br><span class="line">    <span class="attribute">open_file_cache</span> max=<span class="number">1000</span> inactive=<span class="number">20s</span>; </span><br><span class="line">    <span class="attribute">open_file_cache_valid</span> <span class="number">30s</span>; </span><br><span class="line">    <span class="attribute">open_file_cache_min_uses</span> <span class="number">2</span>; </span><br><span class="line">    <span class="attribute">open_file_cache_errors</span> <span class="literal">on</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>proxy_cache_path</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_cache_path</span> /path/to/cache levels=<span class="number">1</span>:<span class="number">2</span> keys_zone=my_cache:<span class="number">10m</span> max_size=<span class="number">10g</span> inactive=<span class="number">60m</span>location / &#123;</span><br><span class="line">        <span class="attribute">proxy_cache</span> my_cache;</span><br><span class="line">        …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="load-balance"><a href="#load-balance" class="headerlink" title="load balance"></a>load balance</h2><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125517.png" alt><br><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200229125522.png" alt><br>nginx LB general config like follow<br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">        …</span><br><span class="line">        <span class="attribute">upstream</span> app_servers &#123;</span><br><span class="line">                 <span class="attribute">server</span> ip1:port1;</span><br><span class="line">                 <span class="attribute">server</span> ip2:port2;</span><br><span class="line">                 <span class="attribute">server</span> ip3:port3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">server</span> &#123;</span><br><span class="line">         …</span><br><span class="line">              <span class="attribute">location</span> / &#123;</span><br><span class="line">                      <span class="attribute">proxy_pass</span> http://app_servers; </span><br><span class="line">              &#125;</span><br><span class="line">        ….</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>real ip</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Host forward</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span> ;</span><br><span class="line"><span class="attribute">proxy</span> set_header Host www.vipumi.com;</span><br></pre></td></tr></table></figure>
</li>
<li><p>session miss</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ip_hash</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">        …</span><br><span class="line">        <span class="attribute">upstream</span> app_servers &#123;</span><br><span class="line">                 ip_hash;</span><br><span class="line">                 <span class="attribute">server</span> ip1:port1;</span><br><span class="line">                 <span class="attribute">server</span> ip2:port2;</span><br><span class="line">                 <span class="attribute">server</span> ip3:port3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">server</span> &#123;</span><br><span class="line">         …</span><br><span class="line">              <span class="attribute">location</span> / &#123;</span><br><span class="line">                  <span class="attribute">proxy_pass</span> http://app_servers; </span><br><span class="line">              &#125;</span><br><span class="line">        ….</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># URL_hash</span></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">        …</span><br><span class="line">        <span class="attribute">upstream</span> app_servers &#123;</span><br><span class="line">            <span class="attribute">hash</span> <span class="variable">$request_uri</span>;</span><br><span class="line">                 <span class="attribute">server</span> ip1:port1;</span><br><span class="line">                 <span class="attribute">server</span> ip2:port2;</span><br><span class="line">                 <span class="attribute">server</span> ip3:port3;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">server</span> &#123;</span><br><span class="line">         …</span><br><span class="line">              <span class="attribute">location</span> / &#123;</span><br><span class="line">                  <span class="attribute">proxy_pass</span> http://app_servers;   </span><br><span class="line">              &#125;</span><br><span class="line">        ….</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># session copy between upstream servers</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># session share: store in zookeeper</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>live ping</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use taobao Tengine module</span></span><br><span class="line"></span><br><span class="line">check interval=3000 rise=2 fall=5 timeout=1000 type=http;  //定义检查间隔、周期、时间</span><br><span class="line">check_keepalive_requests 100;  //一个连接发送的请求数</span><br><span class="line">check_http_send “HEAD / HTTP/1.1\r\nConnection: keep-alive\r\n\r\n”; //定义健康检查方式</span><br><span class="line">check_http_expect_alive http_2xx http_3xx;  //判断后端返回状态码</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h1 id="dynamic-upstream"><a href="#dynamic-upstream" class="headerlink" title="dynamic upstream"></a>dynamic upstream</h1><p><img src="https://raw.githubusercontent.com/fainyang/pictures/master/img/20200301123058.png" alt><br><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># nginx config </span></span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">error_log</span>  logs/error.log  <span class="literal">info</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">log_format</span>  main  <span class="string">'<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] "<span class="variable">$request</span>" '</span></span><br><span class="line">                      <span class="string">'<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> "<span class="variable">$http_referer</span>" '</span></span><br><span class="line">                      <span class="string">'"<span class="variable">$http_user_agent</span>" "<span class="variable">$http_x_forwarded_for</span>"'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="attribute">lua_shared_dict</span> upstreams <span class="number">10m</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">upstream</span> local &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:81</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:82</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">127.0.0.1:83</span>;</span><br><span class="line">        <span class="attribute">balancer_by_lua_file</span> <span class="string">"./ngx_lua/upstream.lua"</span>;</span><br><span class="line">        <span class="comment">#check interval=3000 rise=2 fall=5 timeout=1000;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">800</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> / &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://local;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> = /ups &#123;</span><br><span class="line">            <span class="attribute">default_type</span>  text/plain;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> <span class="string">"./ngx_lua/upsops.lua"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">location</span> = /ups/check &#123;</span><br><span class="line">            <span class="attribute">default_type</span>  text/plain;</span><br><span class="line">            <span class="attribute">content_by_lua_file</span> <span class="string">"./ngx_lua/srvcheck.lua"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">        <span class="comment">#</span></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="attribute">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ol>
<li><p>upstream.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> ups = ngx.shared.upstreams;</span><br><span class="line"><span class="keyword">local</span> upstream = <span class="built_in">require</span> <span class="string">"ngx.upstream"</span></span><br><span class="line"><span class="keyword">local</span> get_servers = upstream.get_servers</span><br><span class="line"><span class="keyword">local</span> set_peer_down = upstream.set_peer_down</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> curr_ups = upstream.current_upstream_name()</span><br><span class="line"><span class="keyword">local</span> srvs = get_servers(curr_ups)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 摘除主节点的服务节点，传入的addr对应于主节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_primary_server_down</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_primary_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">false</span>,peer.id,<span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" failed to set peer down: "</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 摘除备份节点的服务节点，传入的addr对应于备份节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_backup_server_down</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_backup_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">true</span>,peer.id,<span class="literal">true</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" failed to set peer down: "</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 恢复主节点的服务节点，传入的addr对应于主节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_primary_server_up</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_primary_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">false</span>,peer.id,<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" failed to set peer down: "</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 恢复备份节点的服务节点，传入的addr对应于备份节点的name属性</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set_backup_server_up</span><span class="params">(addr)</span></span></span><br><span class="line">    <span class="keyword">local</span> peers = upstream.get_backup_peers(curr_ups)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #peers <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = peers[i]</span><br><span class="line">        <span class="keyword">if</span> peer.name == addr <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> ok, err = set_peer_down(curr_ups,<span class="literal">true</span>,peer.id,<span class="literal">false</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ok <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" failed to set peer down: "</span>..err)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i,peer <span class="keyword">in</span> <span class="built_in">ipairs</span>(srvs) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> isdown = ups:get(peer[<span class="string">"name"</span>])</span><br><span class="line">    <span class="comment">-- 摘除服务节点</span></span><br><span class="line">    <span class="keyword">if</span> isdown == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> peer.backup == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            <span class="comment">-- peer.addr: socket 地址，可能是Lua字符串或lua字符串的数组.</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_primary_server_down(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down success."</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down failed."</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_primary_server_down(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down success."</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down failed."</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> peer.backup == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_backup_server_down(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down success."</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down failed."</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_backup_server_down(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down success."</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set down failed."</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 恢复服务节点</span></span><br><span class="line">    <span class="keyword">elseif</span> isdown == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">if</span> peer.backup == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_primary_server_up(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ups:delete(peer[<span class="string">"name"</span>])</span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up success."</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up failed."</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_primary_server_up(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ups:delete(peer[<span class="string">"name"</span>])</span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up success."</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up failed."</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">elseif</span> peer.backup == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">local</span> addr = peer.addr</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">type</span>(addr) == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">                <span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">ipairs</span>(addr) <span class="keyword">do</span></span><br><span class="line">                    <span class="keyword">if</span> set_backup_server_up(v) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                        ups:delete(peer[<span class="string">"name"</span>])</span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up success."</span>)</span><br><span class="line">                    <span class="keyword">else</span></span><br><span class="line">                        ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up failed."</span>)</span><br><span class="line">                    <span class="keyword">end</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">if</span> set_backup_server_up(addr) == <span class="literal">true</span> <span class="keyword">then</span></span><br><span class="line">                    ups:delete(peer[<span class="string">"name"</span>])</span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.INFO,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up success."</span>)</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    ngx.<span class="built_in">log</span>(ngx.ERR,curr_ups..<span class="string">" "</span>..peer[<span class="string">"name"</span>]..<span class="string">" set up failed."</span>)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>upsops.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">"cjson"</span>;</span><br><span class="line"><span class="keyword">local</span> upstream = <span class="built_in">require</span> <span class="string">"ngx.upstream"</span></span><br><span class="line"><span class="keyword">local</span> ups = ngx.shared.upstreams;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> get_upstreams = upstream.get_upstreams</span><br><span class="line"><span class="keyword">local</span> all_ups = upstream.get_upstreams()</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> op = ngx.req.get_uri_args()[<span class="string">"op"</span>];</span><br><span class="line"><span class="keyword">local</span> server = ngx.req.get_uri_args()[<span class="string">"server"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> op == <span class="literal">nil</span> <span class="keyword">or</span> server == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">    ngx.say(<span class="string">"usage: /ups?op=add&amp;server=192.168.56.101:8080"</span>);</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">down_server</span><span class="params">(upstream_name,server)</span></span></span><br><span class="line">    <span class="keyword">local</span> ret = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">local</span> perrs = upstream.get_servers(upstream_name)</span><br><span class="line">    <span class="keyword">local</span> avail = #perrs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #perrs <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> peer = perrs[i]</span><br><span class="line">        <span class="keyword">local</span> isdown = ups:get(peer[<span class="string">"name"</span>])</span><br><span class="line">        <span class="keyword">if</span> isdown == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">            avail = avail - <span class="number">1</span></span><br><span class="line">            ngx.<span class="built_in">log</span>(ngx.ERR,<span class="string">"## peer.down: true  ups: "</span>..upstream_name..<span class="string">" peer.name: "</span>..peer.name..<span class="string">" server: "</span>..server..<span class="string">" avail: "</span>..avail)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> peer.name == server <span class="keyword">then</span></span><br><span class="line">            ret = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> ret <span class="keyword">then</span></span><br><span class="line">        avail = <span class="number">2</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> avail</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> op == <span class="string">"add"</span> <span class="keyword">then</span></span><br><span class="line">    ups:set(server,<span class="number">0</span>)</span><br><span class="line">    ngx.say(cjson.encode(&#123;code=<span class="string">"A00001"</span>, msg=<span class="string">"add a server success."</span>,data=&#123;server&#125;&#125;))</span><br><span class="line"><span class="keyword">elseif</span> op == <span class="string">"del"</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">local</span> isdown = ups:get(server)</span><br><span class="line">    <span class="keyword">if</span> isdown == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        ngx.say(cjson.encode(&#123;code=<span class="string">"A00001"</span>, msg=<span class="string">"del a server success."</span>,data=&#123;server&#125;&#125;))</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">for</span> _,u <span class="keyword">in</span> <span class="built_in">ipairs</span>(all_ups) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> srvs = upstream.get_servers(u)</span><br><span class="line">        <span class="keyword">for</span> i,peer <span class="keyword">in</span> <span class="built_in">ipairs</span>(srvs) <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> down_svc = down_server(u,server)</span><br><span class="line">            ngx.<span class="built_in">log</span>(ngx.ERR,<span class="string">"## down_svc: "</span>..down_svc..<span class="string">" upstream: "</span>..u..<span class="string">" server: "</span>..server)</span><br><span class="line">            <span class="keyword">if</span> down_svc &lt; <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">                ngx.<span class="built_in">log</span>(ngx.ERR,u..<span class="string">" You cat not set peer down: "</span>..peer[<span class="string">"name"</span>])</span><br><span class="line">                ngx.say(cjson.encode(&#123;code=<span class="string">"E00001"</span>, msg=<span class="string">"You cat not set peer down: "</span>..peer[<span class="string">"name"</span>],data=&#123;peer[<span class="string">"name"</span>]&#125;&#125;))</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    ups:set(server,<span class="number">1</span>)</span><br><span class="line">    ngx.say(cjson.encode(&#123;code=<span class="string">"A00001"</span>, msg=<span class="string">"del a server success."</span>,data=&#123;server&#125;&#125;))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    ngx.say(cjson.encode(&#123;code=<span class="string">"E00001"</span>, msg=<span class="string">"do none."</span>,data=&#123;&#125;&#125;))</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>srvcheck.lua</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> cjson = <span class="built_in">require</span> <span class="string">"cjson"</span>;</span><br><span class="line"><span class="keyword">local</span> ups = ngx.shared.upstreams;</span><br><span class="line"><span class="keyword">local</span> servers = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> _,v <span class="keyword">in</span> <span class="built_in">pairs</span>(ups:get_keys(<span class="number">0</span>)) <span class="keyword">do</span></span><br><span class="line">   servers[v] = ups:get(v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">ngx.say(cjson.encode(&#123;code=<span class="string">"A00001"</span>, msg=<span class="string">"OK"</span>, data=servers&#125;))</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/shell/" rel="tag"># shell</a>
          
            <a href="/tags/nginx/" rel="tag"># nginx</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/post/reviews-2019/" rel="next" title="2019 Reviews">
                <i class="fa fa-chevron-left"></i> 2019 Reviews
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/post/elk-geek/" rel="prev" title="Elasticsearch(elk) technology and practice">
                Elasticsearch(elk) technology and practice <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/feiy.gif" alt="feiyang">
            
              <p class="site-author-name" itemprop="name">feiyang</p>
              <div class="site-description motion-element" itemprop="description">佛系咸鱼</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">28</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">21</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="https://github.com/fainyang" title="GitHub &rarr; https://github.com/fainyang" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i></a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="mailto:fainyang@foxmail.com" title="E-Mail &rarr; mailto:fainyang@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i></a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://wsgzao.github.io/" title="https://wsgzao.github.io/" rel="noopener" target="_blank">奥哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://blog.dploop.org/" title="http://blog.dploop.org/" rel="noopener" target="_blank">强哥</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://www.doglikescat.com" title="http://www.doglikescat.com" rel="noopener" target="_blank">雨城</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#shell"><span class="nav-number">1.</span> <span class="nav-text">shell</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SHORTCUTS"><span class="nav-number">1.1.</span> <span class="nav-text">SHORTCUTS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#find-large-file"><span class="nav-number">1.2.</span> <span class="nav-text">find large file</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#rename"><span class="nav-number">1.3.</span> <span class="nav-text">rename</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#network"><span class="nav-number">1.4.</span> <span class="nav-text">network</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#nginx"><span class="nav-number">2.</span> <span class="nav-text">nginx</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#cpu-affinity"><span class="nav-number">2.1.</span> <span class="nav-text">cpu affinity</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#epoll"><span class="nav-number">2.2.</span> <span class="nav-text">epoll</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sendfile"><span class="nav-number">2.3.</span> <span class="nav-text">sendfile</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gzip"><span class="nav-number">2.4.</span> <span class="nav-text">gzip</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Timing-Variables"><span class="nav-number">2.5.</span> <span class="nav-text">Timing Variables</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#nginx-cache"><span class="nav-number">2.6.</span> <span class="nav-text">nginx cache</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#load-balance"><span class="nav-number">2.7.</span> <span class="nav-text">load balance</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#dynamic-upstream"><span class="nav-number">3.</span> <span class="nav-text">dynamic upstream</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">feiyang</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  
  
  <script id="dsq-count-scr" src="https://feiyang.disqus.com/count.js" async></script>


<script>
  var disqus_config = function() {
    this.page.url = "http://feiyang233.club/post/operation-course/";
    this.page.identifier = "post/operation-course/";
    this.page.title = 'Operation Course Record';
    };
  function loadComments() {
    var d = document, s = d.createElement('script');
    s.src = 'https://feiyang.disqus.com/embed.js';
    s.setAttribute('data-timestamp', '' + +new Date());
    (d.head || d.body).appendChild(s);
  }
  
    $(function() {
      var offsetTop = $('#comments').offset().top - $(window).height();
      if (offsetTop <= 0) {
        // load directly when there's no a scrollbar
        loadComments();
      } else {
        $(window).on('scroll.disqus_scroll', function() {
          // offsetTop may changes because of manually resizing browser window or lazy loading images.
          var offsetTop = $('#comments').offset().top - $(window).height();
          var scrollTop = $(window).scrollTop();

          // pre-load comments a bit? (margin or anything else)
          if (offsetTop - scrollTop < 60) {
            $(window).off('.disqus_scroll');
            loadComments();
          }
        });
      }
    });
  
</script>





  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  
  
  <script>
    
    function addCount(Counter) {
      var $visitors = $('.leancloud_visitors');
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();

      Counter('get', '/classes/Counter', { where: JSON.stringify({ url }) })
        .done(function({ results }) {
          if (results.length > 0) {
            var counter = results[0];
            
            Counter('put', '/classes/Counter/' + counter.objectId, JSON.stringify({ time: { '__op': 'Increment', 'amount': 1 } }))
            
              .done(function() {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.time + 1);
              })
            
              .fail(function ({ responseJSON }) {
                console.log('Failed to save Visitor num, with error message: ' + responseJSON.error);
              })
          } else {
            
              Counter('post', '/classes/Counter', JSON.stringify({ title: title, url: url, time: 1 }))
                .done(function() {
                  var $element = $(document.getElementById(url));
                  $element.find('.leancloud-visitors-count').text(1);
                })
                .fail(function() {
                  console.log('Failed to create');
                });
            
          }
        })
        .fail(function ({ responseJSON }) {
          console.log('LeanCloud Counter Error: ' + responseJSON.code + ' ' + responseJSON.error);
        });
    }
    

    $(function() {
      $.get('https://app-router.leancloud.cn/2/route?appId=' + '8XD7wAXL9l2QyIuNKmfEvTcc-gzGzoHsz')
        .done(function({ api_server }) {
          var Counter = function(method, url, data) {
            return $.ajax({
              method: method,
              url: 'https://' + api_server + '/1.1' + url,
              headers: {
                'X-LC-Id': '8XD7wAXL9l2QyIuNKmfEvTcc-gzGzoHsz',
                'X-LC-Key': 'slQM9YEDoK8hQPyeK4mTGlQs',
                'Content-Type': 'application/json',
              },
              data: data
            });
          };
          
            addCount(Counter);
          
        });
    });
  </script>



  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
